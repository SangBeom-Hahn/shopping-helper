<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Helper</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap">
    <style>
        .top-logo {
            background: white;
            height: 50px;
            width: 200px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .top-long {
            background: white;
            height: 50px;
            width: 210px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .top {
            background: white;
            height: 50px;
            width: 140px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .gallery {
            background: white;
            height: 50px;
            width: 200px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .bold-34 {
            color: #7c6251;
            font-family: 'Poppins', sans-serif;
            font-size: 20px;
            font-weight: bold;
        }
        .bold-20 {
            color: #7c6251;
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
        }
        .divider {
            height: 0.2px;
            background-color: darkgray;
            margin: 0;
        }
        .vh100-desktop-upload {
            height: 100vh;
        }
        .poppins-regular-32 {
            font-size: 32px;
        }
        .padding-h-30 {
            padding-top: 30px;
            padding-bottom: 35px;
        }
        .button {
            background-color: #875D36;
            height: 60px;
            width: 70%;
            border: none;
            color: white;
            box-shadow: 5px 5px 10px 1px gray;
            border-radius: 10px;
            cursor: pointer;
            bottom: 0;
            right: 50%;
            font-family: 'Poppins', sans-serif;
        }
        .padding-bottom-50 {
            padding-bottom: 50px;
        }
        .poppins-regular-18 {
            font-size: 18px;
            text-align: center;
        }
        .poppins-regular-24 {
            font-size: 24px;
            color: #AD6B2D;
        }
        .color-upload-guide-bg {
            background-color: #e0ffff;
        }
        .padding-10 {
            padding: 20px 10px;
            font-size: 17px;
            text-align: center;
            line-height: 2;
        }
        .poppins-bold-18 {
            font-size: 18px;
            font-weight: 700;
        }
        .poppins-bold-20 {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        body {
            margin: 0px;
            font-family: 'Poppins', sans-serif;
        }
        .dropzone-area {
            border: 3px dotted #AD6B2D;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #imagePreview {
            margin-top: 100px;
            width: 100%;
            height: auto;
            display: none;
        }
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            text-align: center;
            padding-top: 20%;
        }
        .v60 {
            margin: auto;
            padding: 0 30px;
        }
        .v80 {
            margin: auto;
            padding: 0 90px;
            width: 70%;
        }
        .uploade-img {
            height: 200px;
            object-fit: contain;
        }
    </style>
</head>
<body onload="sessionStorage.setItem('reviewFormVisible', 'false');">
    <script>
        function previewImage(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const imgPreview = document.getElementById('imagePreview');
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                document.getElementById('uploader-img').style.display = 'none';
                document.getElementById('uploader-message').style.display = 'none';
            }
            reader.readAsDataURL(file);
        }

        async function uploadImage() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];

            if (!file) {
                alert("ì—…ë¡œë“œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            const objectType = document.getElementById('clothing-type').value;
            formData.append('objectType', objectType);
            const refine = document.querySelector('input[name="refine-type"]:checked');
            formData.append('refine', refine.value);

            try {
                let response = await fetch('/api/clothes/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    let data = await response.json();

                    if (data.id) {
                        document.getElementById("loading").style.display = "block";
                        const historyData = await checkInferenceResult(data.id, 0);

                        if (historyData) {
                            sessionStorage.setItem('historyData', JSON.stringify(historyData));
                            sessionStorage.setItem('messageId', data.id);
                            window.location.href = '/api/result';
                        }
                    }
                } else {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‹¤íŒ¨:', error);
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function checkInferenceResult(messageId, callCount) {
            try {
                let historyResponse = await fetch(`/api/clothes/${messageId}`);

                const text = await historyResponse.text();
                if (text) {
                    let historyData = JSON.parse(text);
                    document.getElementById("loading").style.display = "none";
                    return historyData;
                } else if (callCount < 10) {
                    return new Promise((resolve) => {
                        setTimeout(async () => {
                            const result = await checkInferenceResult(messageId, callCount+1);
                            resolve(result);
                        }, 3000);
                    })
                } else {
                    document.getElementById("loading").style.display = "none";
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”.");
                    return null;
                }
            } catch (error) {
                console.error('Error in inference check:', error);
                return null;
            }
        }
    </script>

    <div th:replace="~{fragment/header :: header}"></div>
    <hr class="divider">
    <div class="vh100-desktop-upload">
        <div class="main">
            <div class="v60">
                <div class="poppins-regular-32 padding-h-30" style="margin-left: 80px;">ì°¾ê³  ì‹¶ì€ ë””ìì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                <div class="v80 padding-bottom-50">
                    <div class="stack" style="display: flex; justify-content: space-between;">
                        <div style="width: 50%; min-height: 550px;">
                            <div class="stack" style="display: flex; flex-direction: column; height: 100%;">
                                <div style="height: 100%; border: 3px dotted #AD6B2D; position: relative;">
                                    <div class="dropzone-area" style="height: 100%; position: relative;">
                                        <img id="imagePreview" alt="Image Preview" style="display: none;"/>
                                        <div class="dropzone-text" style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px;">
                                            <img id="uploader-img" class="uploade-img" src="/img/file_plus.png" alt="Upload Image"/>
                                            <div class="uploader-string upload-string-color-gray" style="text-align: center;">
                                                <div id="uploader-message" style="font-size: 22px; color: #979797;">
                                                    ê°€ì´ë“œì— ë§ì¶˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”.<br/>
                                                    .png, .jpg, .heic
                                                </div>
                                            </div>
                                        </div>
                                        <input type="file" id="file-upload" accept=".png, .jpg, .heic" style="display: none;" onchange="previewImage(this)"/>
                                        <label for="file-upload" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: pointer;"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="poppins-regular-18" style="width: 50%; position: relative; margin-left: 16px;">
                            <div class="poppins-regular-24">ì˜ë¥˜ ë””ìì¸ ê°€ì´ë“œ</div>
                            <div class="color-upload-guide-bg" style="margin: 30px 0;">
                                <div class="padding-10" style="padding: 20px 10px;">
                                    1. ê²€ì€ìƒ‰ íœìœ¼ë¡œ í…Œë‘ë¦¬ë¥¼ ê·¸ë ¤ì£¼ì„¸ìš”.
                                    <br/>
                                    í…Œë‘ë¦¬ê°€ ëŠê¹€ì´ ì—†ì„ìˆ˜ë¡ ì™„ì„±ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤.
                                    <br/>
                                    2. ë””ìì¸í•œ ì˜ë¥˜ê°€ ì •ì¤‘ì•™ì— ì˜¤ë„ë¡ í•´ì£¼ì„¸ìš”.
                                    <br/>
                                    (í•œë²ˆì— í•œ ì˜ë¥˜ë§Œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
                                    <br/><br/>
                                    ê²€ìƒ‰ í’ˆì§ˆì„ ë†’ì´ê¸° ìœ„í•´ ê¼­!
                                    <br/>
                                    <a href="/api/guide" style="color: black; font-weight: bold; font-size: 20px;">ìƒì„¸ ê°€ì´ë“œ</a>ë¥¼ ì°¸ê³ í•˜ì—¬ ë””ìì¸ì„ ì™„ì„±í•´ì£¼ì„¸ìš”.
                                </div>
                            </div>
                            <div class="margin-wrapper">
                                Shopping HelperëŠ” <span class="poppins-bold-18">ë”¥ëŸ¬ë‹</span>ì„ ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì±„ìƒ‰, ì¬êµ¬ì„±í•˜ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.
                                <br/><br/>
                                ìœ ì €ì˜ ë°ì´í„°ì— ë”°ë¼ <span class="poppins-bold-18">ìµœì†Œ 5ì´ˆ ~ ìµœëŒ€ 1ë¶„</span> ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                <br/><br/>
                                ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                            </div>
                            <div style="margin: 20px auto;">
                                <label for="clothing-type">ì˜ë¥˜ ì„ íƒ:</label>
                                <select id="clothing-type">
                                    <option value="T_SHIRTS">í‹°ì…”ì¸ </option>
                                    <option value="PANTS">ë°”ì§€</option>
                                    <option value="SKIRT">ì¹˜ë§ˆ</option>
                                    <option value="HAT">ëª¨ì</option>
                                </select>
                            </div>
                            <div style="margin: 20px auto;">
                                <label for="refine-type">ì±„ìƒ‰ ê²°ê³¼ ì •ì œ ì—¬ë¶€:</label>
                                <input type="radio" id="true" name="refine-type" value="true">
                                <label for="true">TRUE</label>
                                <input type="radio" id="false" name="refine-type" value="false">
                                <label for="false">FALSE</label>
                            </div>
                            <button class="button" style="margin: 80px auto auto;" onclick="uploadImage()">
                                <div class="poppins-bold-20">ì´ë¯¸ì§€ ê²€ìƒ‰í•˜ê¸°</div>
                            </button>
                            <div id="loading">ê²€ìƒ‰ ì¤‘ ì…ë‹ˆë‹¤~~ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš¤ğŸ˜</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
